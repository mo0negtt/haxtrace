Soportar deshacer y rehacer globalmente:
Ctrl+Z → undo
Ctrl+Y o Ctrl+Shift+Z → redo
Debe funcionar para: crear/eliminar/mover vértices, crear/eliminar segmentos, editar curva, cambios en bg (opacity/scale/offset), import/export no debe tocar historial.
Implementación: main.js (historial ya existente: saveHistory(), undo(), redo()); asegurar que todas operaciones que modifican mapData llamen a saveHistory() después del cambio.
Imagen de fondo — recordar/persistir
La imagen de fondo se guarda en el estado del mapa y se restaura al recargar/importar:
Guardar DataURL (o URL relativa si es preferible) junto a metadata: { bgImageData: "<dataURI>", bgScale: n, bgOffset: {x,y}, bgOpacity: n } dentro de mapData.
renderer debe cargar esa DataURL al inicializar y aplicar scale/offset/opacity automáticamente.
importExport.exportMap() y handleImportFile() deben incluir/leer esos campos. Si el usuario marca bgRequired en Preferences, bloquear export hasta que bgImageData exista.
Implementación: mapData.js (añadir campos bgImageData/bgScale/bgOffset/bgOpacity), renderer.js (cargar/usar bgImageData), importExport.js (incluir en export/import), uiManager.js (mostrar estado bg y controles).
Performance: guardar DataURL reducido (preview) y opcionalmente full-res sólo al exportar si se desea.
Sincronización y criterios de aceptación rápidos
Al recargar la página:
El layout (panels + topbar visible/oculto) se restaura desde localStorage.
Si mapData.bgImageData existe, la imagen aparece automáticamente con la misma escala/offset/opacidad.
Atajos:
Ctrl+Z y Ctrl+Y funcionan en todo momento (no bloqueados por inputs); inputs deben permitir Ctrl+Z local para texto, pero global undo del mapa debe activarse si el foco está en el canvas o si no hay caja de texto activa.
Export/Import:
El .hbs exportado contiene los campos de bgImageData y metadata; al importar se restaura exactamente.
Si bgRequired está activo y no hay bgImageData, Export muestra advertencia y bloquea export.
No romper regresiones: las funciones previas (añadir vértice, segmentos, curvas) siguen funcionando.